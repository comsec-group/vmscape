From e91a00ddca23a99b8a9743a47e6033007bd866ca Mon Sep 17 00:00:00 2001
From: Jean-Claude Graf <mail@jeanclaudegraf.ch>
Date: Tue, 16 Sep 2025 12:08:23 +0200
Subject: [PATCH] Execute IBPB on every VMExit

---
 arch/x86/kvm/svm/vmenter.S | 2 ++
 arch/x86/kvm/vmx/vmenter.S | 1 +
 2 files changed, 3 insertions(+)

diff --git a/arch/x86/kvm/svm/vmenter.S b/arch/x86/kvm/svm/vmenter.S
index 235c4af6b692..2c86f32d27dc 100644
--- a/arch/x86/kvm/svm/vmenter.S
+++ b/arch/x86/kvm/svm/vmenter.S
@@ -221,6 +221,7 @@ SYM_FUNC_START(__svm_vcpu_run)
 	 * because interrupt handlers won't sanitize 'ret' if the return is
 	 * from the kernel.
 	 */
+	 call write_ibpb
 	UNTRAIN_RET_VM
 
 	/*
@@ -357,6 +358,7 @@ SYM_FUNC_START(__svm_sev_es_vcpu_run)
 	 * because interrupt handlers won't sanitize RET if the return is
 	 * from the kernel.
 	 */
+	call write_ibpb
 	UNTRAIN_RET_VM
 
 	FRAME_END
diff --git a/arch/x86/kvm/vmx/vmenter.S b/arch/x86/kvm/vmx/vmenter.S
index 0a6cf5bff2aa..77ea460b2f2e 100644
--- a/arch/x86/kvm/vmx/vmenter.S
+++ b/arch/x86/kvm/vmx/vmenter.S
@@ -273,6 +273,7 @@ SYM_INNER_LABEL_ALIGN(vmx_vmexit, SYM_L_GLOBAL)
 	pop %_ASM_ARG1	/* @vmx */
 
 	call vmx_spec_ctrl_restore_host
+	call write_ibpb
 
 	CLEAR_BRANCH_HISTORY_VMEXIT
 
-- 
2.51.0

